<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Win32编程基础Chapter 6：第一个窗口程序 | 黑客技术学习分享自留地</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="MinHow's Blog">
  
  <meta name="description" content="0x00 程序与窗口的关系一个窗口不一定就是一个程序，它可能只是程序的一部分，一个程序可以有多个顶层窗口，一个顶层窗口又可以有多个子窗口，子窗口又可以有子窗口。 程序也不一定是窗口，如果一个程序不需要与用户进行交互，那么他可以不建立窗口。 DOS程序是过程驱动的。窗口程序是事件驱动的。">
<meta name="keywords" content="Win32,汇编语言">
<meta property="og:type" content="article">
<meta property="og:title" content="Win32编程基础Chapter 6：第一个窗口程序">
<meta property="og:url" content="https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/index.html">
<meta property="og:site_name" content="黑客技术学习分享自留地">
<meta property="og:description" content="0x00 程序与窗口的关系一个窗口不一定就是一个程序，它可能只是程序的一部分，一个程序可以有多个顶层窗口，一个顶层窗口又可以有多个子窗口，子窗口又可以有子窗口。 程序也不一定是窗口，如果一个程序不需要与用户进行交互，那么他可以不建立窗口。 DOS程序是过程驱动的。窗口程序是事件驱动的。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/Image.png">
<meta property="og:image" content="https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/Image%20[2].png">
<meta property="og:updated_time" content="2019-05-21T02:42:09.028Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Win32编程基础Chapter 6：第一个窗口程序">
<meta name="twitter:description" content="0x00 程序与窗口的关系一个窗口不一定就是一个程序，它可能只是程序的一部分，一个程序可以有多个顶层窗口，一个顶层窗口又可以有多个子窗口，子窗口又可以有子窗口。 程序也不一定是窗口，如果一个程序不需要与用户进行交互，那么他可以不建立窗口。 DOS程序是过程驱动的。窗口程序是事件驱动的。">
<meta name="twitter:image" content="https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/Image.png">
  
  
    <link rel="icon" href="/LimeWire.png">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  

  
  

</head>
</html>
<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">sh4dow&#39;s Blog</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a href="/">
                        <i class="fa fa-home"></i>
                        <span>Home</span>
                    </a>
                    
                    <a href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>Archives</span>
                    </a>
                    
                    <a href="/about">
                        <i class="fa fa-user"></i>
                        <span>About</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        sh4dow&#39;s Blog
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        不能成为自己喜欢的人，至少成为自己认可的黑客。
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="Home" target="_blank" href="https://sakuxa.com">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="Github" target="_blank" href="https://github.com/sh4douu">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                        <a title="Weibo" target="_blank" href="https://sakuxa.com">
                            <i class="fa fa-weibo fa-2x"></i></a>
                    
                        <a title="Twitter" target="_blank" href="https://sakuxa.com">
                            <i class="fa fa-twitter fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-06-win32编程基础Chapter-6" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      Win32编程基础Chapter 6：第一个窗口程序
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/Win32/">Win32</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2019-04-02
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <h4 id="0x00-程序与窗口的关系"><a href="#0x00-程序与窗口的关系" class="headerlink" title="0x00 程序与窗口的关系"></a>0x00 程序与窗口的关系</h4><p>一个窗口不一定就是一个程序，它可能只是程序的一部分，一个程序可以有多个顶层窗口，一个顶层窗口又可以有多个子窗口，子窗口又可以有子窗口。</p>
<p>程序也不一定是窗口，如果一个程序不需要与用户进行交互，那么他可以不建立窗口。</p>
<p>DOS程序是过程驱动的。窗口程序是事件驱动的。</p>
<a id="more"></a>
<p><img src="/2019/04/02/06-win32编程基础Chapter-6/Image.png" alt></p>
<h4 id="0x01-消息队列"><a href="#0x01-消息队列" class="headerlink" title="0x01 消息队列"></a>0x01 消息队列</h4><p>Windows在系统内部有一个系统队列，当输入设备有所动作（键盘输入、鼠标移动/点击等），Winodws会产生相应的记录并放到系统消息队列中。同时，Windows还会为每个窗口程序（严格说是每个线程）维护一个消息队列。</p>
<p><img src="/2019/04/02/06-win32编程基础Chapter-6/Image [2].png" alt></p>
<h4 id="0x02-模块与句柄"><a href="#0x02-模块与句柄" class="headerlink" title="0x02 模块与句柄"></a>0x02 模块与句柄</h4><p>模块：</p>
<blockquote>
<p>一个运行中的.exe或dll就是一个模块，包括代码和所有资源。即在硬盘上的文件不能称为模块，加载到内存后才能称为模块。dll被不同程序加载到内存就产生了不同模块，以隔离地址空间。</p>
</blockquote>
<p>句柄：</p>
<blockquote>
<p>为了能够区分不同模块，因此产生了句柄用来唯一标识每个模块。句柄只是一个数值，它对程序是没意义的，它只是Windows用来区分不同资源的编号，以便Window能够区分和使用。</p>
</blockquote>
<p>简单来说：</p>
<blockquote>
<p>Windows为每个窗口、dll等都各分配一个句柄，并记录窗口、dll等与句柄的对应关系。</p>
<p>Windows将句柄给程序，程序操作句柄等同于操作窗口。</p>
<p>Windows也可以通过我们传入的句柄知道程序要操作的窗口。</p>
<p>Windows上几乎所有东西都用句柄标识：文件句柄、窗口句柄、模块句柄、线程句柄等。</p>
</blockquote>
<p>获取句柄：</p>
<blockquote>
<p>在Win32中，模块句柄数值上等于程序装入内存的起始地址。</p>
</blockquote>
<p>可以用API函数GetModuleHandle获取模块的句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke GetModuleHandle,lpModuleName  ;lpModuleName参数是指向模块名称字符串地址的指针。</span><br></pre></td></tr></table></figure>
<p>PS：如果lpModuleName参数使用NULL，返回得到的是调用者自身的本模块句柄。为了便利会先把程序的句柄获取并放在全局变量保存。</p>
<p>API函数返回值即模块的句柄，存储在EAX中。 </p>
<h4 id="0x03-窗口程序"><a href="#0x03-窗口程序" class="headerlink" title="0x03 窗口程序"></a>0x03 窗口程序</h4><p>1.一个程序的结构流程：</p>
<blockquote>
<p>得到应用程序的句柄（GetModuleHandle）</p>
<p>注册窗口类(RegisterClassEx) </p>
<p>建立窗口（CreateWindowEx） </p>
<p>显示窗口（ShowWindows） </p>
<p>刷新窗口客户区（UpdateWindow） </p>
<p>进入无限的消息获取和处理的循环：</p>
<ul>
<li>获得消息（GetMessage）</li>
<li>消息处理（TranslateMessage ）</li>
<li>分派消息（DispatchMessage）</li>
</ul>
</blockquote>
<p>2.注册窗口类：</p>
<blockquote>
<p>建立窗口类的方法是在系统中注册，注册窗口类的API函数是 <code>RegisterClassEx</code>，最后的“Ex”是扩展的意思，因为它是 Win16 中<code>RegisterClass</code>的扩展。</p>
</blockquote>
<p>一个窗口类定义了窗口的一些主要属性，如：图标、光标、背景色、菜单和负责处理所属该窗口消息的函数。这些属性并不是分成多个参数传递过去的（这种做法不聪明），而是定义在一个<code>WNDCLASSEX</code>结构中，再把结构的地址当参数一次性传递给 <code>RegisterClassEx</code>。</p>
<p>WNDCLASSEX结构定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WNDCLASSEX STRUCT </span><br><span class="line"></span><br><span class="line">CbSize         DWORD   ?  ;结构的字节数</span><br><span class="line">Style          DWORD   ?  ;类风格  </span><br><span class="line">LpfnWndProc    DWORD   ?  **;窗口过程的地址,****回调函数的地址。**</span><br><span class="line">CbClsExtra     DWORD   ?  </span><br><span class="line">CbWndExtra     DWORD   ?  </span><br><span class="line">HInstance      DWORD   ?  ;**指定窗口类属于的模块，传入模块的句柄。**  </span><br><span class="line">HIcon          DWORD   ?  ;窗口左上角的图标  </span><br><span class="line">HCursor        DWORD   ?  ;窗口光标  </span><br><span class="line">HbrBackground  DWORD   ?  ;窗口客户区的背景色  </span><br><span class="line">LpszMenuName   DWORD   ?  ;窗口菜单  </span><br><span class="line">LpszClassName  DWORD   ?  **;要注册的类的字符串名字，指向类名字符串地址的指针。**  </span><br><span class="line">HIconSm        DWORD   ?  ;小图标 </span><br><span class="line"></span><br><span class="line">WNDCLASSEX ENDS</span><br></pre></td></tr></table></figure>
<ul>
<li>LpfnWndProc</li>
</ul>
<blockquote>
<p>基于这个类创建的窗口都使用该回调函数，即一个窗口过程可以服务多个窗口，只要它们是由同一个窗口类创建的。</p>
<p>Windows运行到DispatchMessage函数时，会把消息传给该过程函数。</p>
</blockquote>
<p>注册窗口类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local   stWndClass:WNDCLASSEX             ;以WNDCLASSEX结构为类型定义一个结构。</span><br><span class="line">invoke  RegisterClassEx,addr stWndClass   ;调用注册函数进行窗口类注册</span><br></pre></td></tr></table></figure>
<p>3.建立窗口：</p>
<blockquote>
<p>利用上一步注册的窗口类为基础（模板）来创建一个窗口。</p>
</blockquote>
<p>和注册窗口类时用一个结构传递所有参数不同，建立窗口时所有的属性都是用单个参数的方式传递的，建立窗口的API函数是<code>CreateWindowEx</code>。  </p>
<p>建立窗口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke   CreateWindowEx, dwExStyle, lpClassName,lpWindowName, dwStyle, x, y, nWidth, nHeight, hWndParent, hMenu, hInstance,lpParam</span><br></pre></td></tr></table></figure>
<p>参数解析：</p>
<ul>
<li><code>lpClassName</code>：传入上一步注册的类的字符串名称。表示使用该类为模板创建窗口，会继承窗口类的属性以及使用窗口类指定的窗口过程。 </li>
<li><code>lpWindowName</code>：窗口的标题。指向窗口标题字符串地址的指针。 </li>
<li><code>hInstance</code>：窗口所属的模块的句柄。</li>
<li><code>dwExStyle、dwStyle</code>：窗口的两个参数 dwStyle 和 dwExStyle 决定了窗口的外形和行为，们是一些以WS（Windows Style的缩写）为开头的预定义值，具体查文档。</li>
<li><code>x, y</code>：指定窗口左上角位置，单位是像素（px）。即窗口的位置。</li>
<li><code>nWidth、nHeight</code>：窗口的宽度和高度，也就是窗口的大小，同样是以像素为单位的。</li>
</ul>
<p>CreateWindowEx 建立窗口以后，eax 中传回来的是窗口句柄，注意要把它先保存起来，因为这时候，窗口虽已建立，但还没有在屏幕上显示出来。</p>
<p>4.显示窗口：</p>
<blockquote>
<p><code>ShowWindow</code>用于显示上一步创建的窗口，该函数有两个参数，第一个参数是要显示的窗口的句柄，第二个参数是显示的方式，显示的方式是众多预定义的值，具体定义查文档。</p>
</blockquote>
<p>5.绘制窗口：</p>
<blockquote>
<p>窗口显示以后，用 <code>UpdateWindow</code> 绘制客户区，它实际上就是向窗口发送了一条 <code>WM_PAINT</code> 消息。到此为止，一个顶层窗口才算正常建立并显示！ </p>
</blockquote>
<p>绘制窗口，传入要绘制的窗口的句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke UpdateWindow,hxxxx</span><br></pre></td></tr></table></figure>
<p>6.消息循环：</p>
<p>消息循环中的几个函数要用到一个MSG结构，用来做消息传递：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MSG STRUCT  </span><br><span class="line"></span><br><span class="line">Hwnd      DWORD     ?   ;消息要发向的窗口的句柄。</span><br><span class="line">Message   DWORD     ?   ;消息标识符，在头文件中以WM_开头的预定义值。</span><br><span class="line">WParam    DWORD     ?   ;消息的参数之一。</span><br><span class="line">LParam    DWORD     ?   ;消息的参数之二。</span><br><span class="line">Time      DWORD     ?   ;消息放入消息队列的时间。</span><br><span class="line">Pt        POINT     &lt;&gt;  ;这是一个POINT数据结构，表示消息放入消息队列时的鼠标坐标。</span><br><span class="line"></span><br><span class="line">MSG ENDS</span><br></pre></td></tr></table></figure>
<p>获取消息：</p>
<blockquote>
<p><code>GetMessage</code> 函数从消息队列里取得消息，用取得的消息填写到传入的MSG结构。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke  GetMessage, lpMsg, hWnd, wMsgFilterMin,wMsgFilterMax ;</span><br></pre></td></tr></table></figure>
<p>参数解析：</p>
<ul>
<li>lpMsg：指向一个MSG结构，函数取到的消息填写MSG后返回。</li>
<li>hWnd：传入要获取消息的的窗口句柄。指定为NULL表示获取所有本程序的窗口的消息。</li>
<li>wMsgFilterMin 和wMsgFilterMax 为0表示获取所有编号的消息。</li>
</ul>
<p><code>TranslateMessage</code>的作用是遇到键盘消息则将扫描码转换成ASCII码并在消息队列中插入<code>WM_CHAR</code> 或<code>WM_SYSCHAR</code>消息，参数就是转换好的ASCII码。   </p>
<p>最后，由 <code>DispatchMessage</code> 将消息（<code>GetMessage</code>填写好的MSG结构）发送到窗口对应的窗口过程去处理。</p>
<p>窗口过程返回后 <code>DispatchMessage</code> 函数才返回，然后开始新一轮消息循环。</p>
<h4 id="0x04-Win窗口程序编写模板"><a href="#0x04-Win窗口程序编写模板" class="headerlink" title="0x04 Win窗口程序编写模板"></a>0x04 Win窗口程序编写模板</h4><p>该模板是用C调用API函数编写的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwhd,UINT,WPARAM wParam,LPARAM IParam)</span></span>;   <span class="comment">//回调函数（过程函数）原型。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance,HINSTANCE hPreInstance,PSTR szCmdline,<span class="keyword">int</span> iCmdShow )</span>   <span class="comment">//WinMain函数由系统调用。</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     \* ------------------------注册窗口类---------------------------------*\</span><br><span class="line"></span><br><span class="line">     <span class="keyword">static</span> TCHAR szAppName[] = TEXT(<span class="string">"MyWindows"</span>);     <span class="comment">//声明并初始化一个字符串，用作注册的窗口类的名称</span></span><br><span class="line">     </span><br><span class="line">     WNDCLASS wndclass;                          <span class="comment">//以WNDCLASS结构为模板，声明一个结构名为wndclass的结构。</span></span><br><span class="line">     wndclass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">     wndclass.lpfnWndProc = WindowProc;          <span class="comment">//指明回调函数名称（函数名本质是地址，因此是指针）。</span></span><br><span class="line">     wndclass.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">     wndclass.cbWndExtra = <span class="number">0</span>;</span><br><span class="line">     wndclass.hInstance = hInstance;             <span class="comment">//程序当前实例的句柄，由WinMain函数传入。</span></span><br><span class="line">     wndclass.hIcon = LoadIcon(<span class="literal">NULL</span>, IDI_APPLICATION);              <span class="comment">//图标</span></span><br><span class="line">     wndclass.hCursor = LoadCursor(<span class="literal">NULL</span>, IDC_ARROW);                <span class="comment">//光标</span></span><br><span class="line">     wndclass.hbrBackground = (HBRUSH)GetStockObject(WHITE_BRUSH);  <span class="comment">//窗口背景色</span></span><br><span class="line">     wndclass.lpszMenuName = <span class="literal">NULL</span>;                                  <span class="comment">//窗口菜单</span></span><br><span class="line">     wndclass.lpszClassName = szAppName;     <span class="comment">//注册的窗口类的字符串名称。（要求指针，因此是字符串的地址）</span></span><br><span class="line"></span><br><span class="line">     RegisterClass(&amp;wndclass);     <span class="comment">//注册窗口类，类的信息定义在WNDCLASS结构中。传入结构的地址作为参数。</span></span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">     \* ------------------------创建窗口---------------------------------*\</span><br><span class="line"></span><br><span class="line">     HWND hwnd;     <span class="comment">//声明一个句柄结构类型的变量。(通常声明于WinMain函数内部顶部，此处为了方便观看)</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">//根据窗口类创建窗口，并返回窗口的句柄。</span></span><br><span class="line">     hwnd = CreateWindow( szAppName,                  <span class="comment">//上一步中注册的类的名称（字符串地址）。</span></span><br><span class="line">                         TEXT(<span class="string">"MyWindow"</span>),           <span class="comment">//窗口的标题（字符串地址）。</span></span><br><span class="line">                         WS_OVERLAPPEDWINDOW,</span><br><span class="line">                         CW_USEDEFAULT,</span><br><span class="line">                         CW_USEDEFAULT,</span><br><span class="line">                         CW_USEDEFAULT,</span><br><span class="line">                         CW_USEDEFAULT,</span><br><span class="line">                         <span class="literal">NULL</span>,</span><br><span class="line">                         <span class="literal">NULL</span>,</span><br><span class="line">                         hInstance,                  <span class="comment">//程序当前实例的句柄，由WinMain函数传入。</span></span><br><span class="line">                         <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     \* ------------------------显示、绘制窗口---------------------------------*/</span><br><span class="line"></span><br><span class="line">     ShowWindow(hwnd,iCmdShow);      <span class="comment">//传入要显示的窗口的句柄。</span></span><br><span class="line">     UpdateWindow(hwnd);             <span class="comment">//传入要绘制的窗口句柄，实际上就是向窗口发送了一条 WM_PAINT 消息。</span></span><br><span class="line"></span><br><span class="line">     \* ------------------------消息处理---------------------------------*/</span><br><span class="line"></span><br><span class="line">     MSG msg;        <span class="comment">//一个MSG结构为类型，声明一个结构名为msg的结构。</span></span><br><span class="line">     </span><br><span class="line">     <span class="keyword">while</span>(GetMessage(&amp;msg,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>))    <span class="comment">//传入的时msg结构的地址，因此三个函数操作的都是同一的对象。</span></span><br><span class="line">     &#123;</span><br><span class="line">         TranslateMessage(&amp;msg);</span><br><span class="line">         DispatchMessage(&amp;msg);          <span class="comment">//将消息分发给回调函数WindowProc**</span></span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> msg.wParam;  <span class="comment">//当接收到一个WM_QUIT消息时，程序就中止。并且返回传递给WM_QUIT消息的wParam参数的值。</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</span>  <span class="comment">//回调函数定义</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    HDC hdc;</span><br><span class="line">    PAINTSTRUCT ps;</span><br><span class="line">    RECT rect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (message)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="keyword">case</span> WM_PAINT:</span><br><span class="line">           hdc = BeginPaint(hwnd, &amp;ps);</span><br><span class="line">           GetClientRect(hwnd, &amp;rect);</span><br><span class="line">           DrawText(hdc, TEXT(<span class="string">"Hello World!"</span>), <span class="number">-1</span>, &amp;rect,DT_SINGLELINE | DT_CENTER | DT_VCENTER);</span><br><span class="line">           EndPaint(hwnd, &amp;ps);</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">       <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">           PostQuitMessage(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DefWindowProc(hwnd, message, wParam, lParam); <span class="comment">//若消息没有匹配到上面，默认执行该操作。</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2019年05月21日 10:42</p>
        <p>原始链接： <a class="post-url" href="/2019/04/02/06-win32编程基础Chapter-6/" title="Win32编程基础Chapter 6：第一个窗口程序">https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/</a></p>
        <footer>
            <a href="https://sakuxa.com">
                <img src="/images/logo.png" alt="sh4douu">
                sh4douu
            </a>
        </footer>
    </div>
</div>

      
        
            

        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/&title=《Win32编程基础Chapter 6：第一个窗口程序》 — 黑客技术学习分享自留地&pic=images/timg7.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/&title=《Win32编程基础Chapter 6：第一个窗口程序》 — 黑客技术学习分享自留地&source=0x00 程序与窗口的关系一个窗口不一定就是一个程序，它可能只是程序的一部分，一个程序可以有多个顶层窗口，一个顶层窗口又可以有多个子窗口，子窗口又可以有子..." data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Win32编程基础Chapter 6：第一个窗口程序》 — 黑客技术学习分享自留地&url=https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/&via=https://sakuxa.com" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://sakuxa.com/2019/04/02/06-win32编程基础Chapter-6/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/Win32/" class="color1">Win32</a>
      
    <a href="/tags/汇编语言/" class="color5">汇编语言</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x00-程序与窗口的关系"><span class="post-toc-text">0x00 程序与窗口的关系</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x01-消息队列"><span class="post-toc-text">0x01 消息队列</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x02-模块与句柄"><span class="post-toc-text">0x02 模块与句柄</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x03-窗口程序"><span class="post-toc-text">0x03 窗口程序</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x04-Win窗口程序编写模板"><span class="post-toc-text">0x04 Win窗口程序编写模板</span></a></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2019/04/03/01-Windows认证之NTLM/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          Windows认证之NTLM
        
      </span>
    </a>
  
  
    <a href="/2019/04/02/04-win32编程基础Chapter-5/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">Win32编程基础Chapter 5：分支和循环</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2019 sh4douu<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "https://sakuxa.com",
      animate: true,
      isHome: false,
      share: true,
      reward: 0
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/Misc/">Misc</a><a class="category-link" href="/categories/Pikachu/">Pikachu</a><a class="category-link" href="/categories/Python/">Python</a><a class="category-link" href="/categories/Vulnhub/">Vulnhub</a><a class="category-link" href="/categories/WEB漏洞学习/">WEB漏洞学习</a><a class="category-link" href="/categories/Win32/">Win32</a><a class="category-link" href="/categories/内网渗透/">内网渗透</a><a class="category-link" href="/categories/无线渗透/">无线渗透</a><a class="category-link" href="/categories/漏洞复现/">漏洞复现</a><a class="category-link" href="/categories/语言/">语言</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/802-11/" style="font-size: 10px;">802.11</a> <a href="/tags/CSRF/" style="font-size: 10px;">CSRF</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Cheatsheet/" style="font-size: 10px;">Cheatsheet</a> <a href="/tags/Getshell/" style="font-size: 10px;">Getshell</a> <a href="/tags/HTML文档解析/" style="font-size: 10px;">HTML文档解析</a> <a href="/tags/Kerberos/" style="font-size: 10px;">Kerberos</a> <a href="/tags/Language/" style="font-size: 20px;">Language</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Mimikatz/" style="font-size: 10px;">Mimikatz</a> <a href="/tags/My-Ubuntu/" style="font-size: 10px;">My Ubuntu</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/MyUbuntu/" style="font-size: 10px;">MyUbuntu</a> <a href="/tags/NTLM/" style="font-size: 10px;">NTLM</a> <a href="/tags/NetBIOS/" style="font-size: 10px;">NetBIOS</a> <a href="/tags/OWASP-Top10-2017/" style="font-size: 10px;">OWASP Top10 2017</a> <a href="/tags/PHP/" style="font-size: 10px;">PHP</a> <a href="/tags/PHPCMSv9/" style="font-size: 10px;">PHPCMSv9</a> <a href="/tags/Pass-The-Hash/" style="font-size: 10px;">Pass The Hash</a> <a href="/tags/Payload/" style="font-size: 10px;">Payload</a> <a href="/tags/Python基础/" style="font-size: 18px;">Python基础</a> <a href="/tags/Python模块/" style="font-size: 12px;">Python模块</a> <a href="/tags/Re/" style="font-size: 10px;">Re</a> <a href="/tags/SMB/" style="font-size: 10px;">SMB</a> <a href="/tags/SQL注入/" style="font-size: 10px;">SQL注入</a> <a href="/tags/SecTools/" style="font-size: 10px;">SecTools</a> <a href="/tags/Tools/" style="font-size: 10px;">Tools</a> <a href="/tags/Ubuntu-2-Mac/" style="font-size: 10px;">Ubuntu 2 Mac</a> <a href="/tags/WEB安全/" style="font-size: 12px;">WEB安全</a> <a href="/tags/WLAN/" style="font-size: 10px;">WLAN</a> <a href="/tags/Win32/" style="font-size: 16px;">Win32</a> <a href="/tags/Winodows/" style="font-size: 10px;">Winodows</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/XML注入/" style="font-size: 10px;">XML注入</a> <a href="/tags/XSS/" style="font-size: 14px;">XSS</a> <a href="/tags/XXE/" style="font-size: 12px;">XXE</a> <a href="/tags/base64/" style="font-size: 10px;">base64</a> <a href="/tags/subprocess/" style="font-size: 10px;">subprocess</a> <a href="/tags/任意文件下载/" style="font-size: 10px;">任意文件下载</a> <a href="/tags/干货/" style="font-size: 10px;">干货</a> <a href="/tags/必会技能/" style="font-size: 10px;">必会技能</a> <a href="/tags/技术/" style="font-size: 10px;">技术</a> <a href="/tags/收集/" style="font-size: 10px;">收集</a> <a href="/tags/文件上传/" style="font-size: 10px;">文件上传</a> <a href="/tags/文件包含/" style="font-size: 10px;">文件包含</a> <a href="/tags/文件描述符/" style="font-size: 10px;">文件描述符</a> <a href="/tags/文件权限/" style="font-size: 10px;">文件权限</a> <a href="/tags/无线渗透/" style="font-size: 10px;">无线渗透</a> <a href="/tags/暴力破解/" style="font-size: 10px;">暴力破解</a> <a href="/tags/权限提升/" style="font-size: 10px;">权限提升</a> <a href="/tags/汇编语言/" style="font-size: 16px;">汇编语言</a> <a href="/tags/环境搭建/" style="font-size: 10px;">环境搭建</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/编码与解码/" style="font-size: 10px;">编码与解码</a> <a href="/tags/跨站请求伪造/" style="font-size: 10px;">跨站请求伪造</a> <a href="/tags/过滤与绕过/" style="font-size: 10px;">过滤与绕过</a> <a href="/tags/重定向/" style="font-size: 10px;">重定向</a> <a href="/tags/靶场/" style="font-size: 14px;">靶场</a> <a href="/tags/靶机/" style="font-size: 10px;">靶机</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a href="/">
                    <i class="fa fa-home"></i><span>Home</span>
                </a>
            </li>
            
            <li>
                <a href="/archives">
                    <i class="fa fa-archive"></i><span>Archives</span>
                </a>
            </li>
            
            <li>
                <a href="/about">
                    <i class="fa fa-user"></i><span>About</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/802-11/" style="font-size: 10px;">802.11</a> <a href="/tags/CSRF/" style="font-size: 10px;">CSRF</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Cheatsheet/" style="font-size: 10px;">Cheatsheet</a> <a href="/tags/Getshell/" style="font-size: 10px;">Getshell</a> <a href="/tags/HTML文档解析/" style="font-size: 10px;">HTML文档解析</a> <a href="/tags/Kerberos/" style="font-size: 10px;">Kerberos</a> <a href="/tags/Language/" style="font-size: 20px;">Language</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Mimikatz/" style="font-size: 10px;">Mimikatz</a> <a href="/tags/My-Ubuntu/" style="font-size: 10px;">My Ubuntu</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/MyUbuntu/" style="font-size: 10px;">MyUbuntu</a> <a href="/tags/NTLM/" style="font-size: 10px;">NTLM</a> <a href="/tags/NetBIOS/" style="font-size: 10px;">NetBIOS</a> <a href="/tags/OWASP-Top10-2017/" style="font-size: 10px;">OWASP Top10 2017</a> <a href="/tags/PHP/" style="font-size: 10px;">PHP</a> <a href="/tags/PHPCMSv9/" style="font-size: 10px;">PHPCMSv9</a> <a href="/tags/Pass-The-Hash/" style="font-size: 10px;">Pass The Hash</a> <a href="/tags/Payload/" style="font-size: 10px;">Payload</a> <a href="/tags/Python基础/" style="font-size: 18px;">Python基础</a> <a href="/tags/Python模块/" style="font-size: 12px;">Python模块</a> <a href="/tags/Re/" style="font-size: 10px;">Re</a> <a href="/tags/SMB/" style="font-size: 10px;">SMB</a> <a href="/tags/SQL注入/" style="font-size: 10px;">SQL注入</a> <a href="/tags/SecTools/" style="font-size: 10px;">SecTools</a> <a href="/tags/Tools/" style="font-size: 10px;">Tools</a> <a href="/tags/Ubuntu-2-Mac/" style="font-size: 10px;">Ubuntu 2 Mac</a> <a href="/tags/WEB安全/" style="font-size: 12px;">WEB安全</a> <a href="/tags/WLAN/" style="font-size: 10px;">WLAN</a> <a href="/tags/Win32/" style="font-size: 16px;">Win32</a> <a href="/tags/Winodows/" style="font-size: 10px;">Winodows</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/XML注入/" style="font-size: 10px;">XML注入</a> <a href="/tags/XSS/" style="font-size: 14px;">XSS</a> <a href="/tags/XXE/" style="font-size: 12px;">XXE</a> <a href="/tags/base64/" style="font-size: 10px;">base64</a> <a href="/tags/subprocess/" style="font-size: 10px;">subprocess</a> <a href="/tags/任意文件下载/" style="font-size: 10px;">任意文件下载</a> <a href="/tags/干货/" style="font-size: 10px;">干货</a> <a href="/tags/必会技能/" style="font-size: 10px;">必会技能</a> <a href="/tags/技术/" style="font-size: 10px;">技术</a> <a href="/tags/收集/" style="font-size: 10px;">收集</a> <a href="/tags/文件上传/" style="font-size: 10px;">文件上传</a> <a href="/tags/文件包含/" style="font-size: 10px;">文件包含</a> <a href="/tags/文件描述符/" style="font-size: 10px;">文件描述符</a> <a href="/tags/文件权限/" style="font-size: 10px;">文件权限</a> <a href="/tags/无线渗透/" style="font-size: 10px;">无线渗透</a> <a href="/tags/暴力破解/" style="font-size: 10px;">暴力破解</a> <a href="/tags/权限提升/" style="font-size: 10px;">权限提升</a> <a href="/tags/汇编语言/" style="font-size: 16px;">汇编语言</a> <a href="/tags/环境搭建/" style="font-size: 10px;">环境搭建</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/编码与解码/" style="font-size: 10px;">编码与解码</a> <a href="/tags/跨站请求伪造/" style="font-size: 10px;">跨站请求伪造</a> <a href="/tags/过滤与绕过/" style="font-size: 10px;">过滤与绕过</a> <a href="/tags/重定向/" style="font-size: 10px;">重定向</a> <a href="/tags/靶场/" style="font-size: 14px;">靶场</a> <a href="/tags/靶机/" style="font-size: 10px;">靶机</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>


  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
</body>
</html>